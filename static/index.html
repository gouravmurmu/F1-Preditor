<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 2026 Race Predictor</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        h1 { color: #e10600; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input { width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #e10600; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #c10500; }
        .driver-row { display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .driver-row > div { flex: 1; }
        #results { margin-top: 20px; }
        .result-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .result-item:first-child { font-weight: bold; background-color: #fff8f8; }
    </style>
</head>
<body>
    <h1>F1 2026 Race Predictor</h1>
    
    <div class="card">
        <h2>Race Settings</h2>
        <label for="location">Circuit / Location</label>
        <select id="location"></select>
    </div>

    <div class="card">
        <h2>Drivers & Grid</h2>
        <div id="drivers-container">
            <!-- Driver rows will be added here -->
        </div>
        <button onclick="addDriverRow()">+ Add Driver</button>
    </div>

    <button onclick="predict()" style="width: 100%;">Predict Race Winner</button>

    <div id="results" class="card" style="display: none;">
        <h2>Prediction Results</h2>
        <div id="results-list"></div>
    </div>

    <script>
        let driversList = [];
        let constructorsList = [];

        async function fetchData() {
            try {
                const [driversRes, constructorsRes, locationsRes] = await Promise.all([
                    fetch('/drivers'),
                    fetch('/constructors'),
                    fetch('/locations')
                ]);

                driversList = await driversRes.json();
                constructorsList = await constructorsRes.json();
                const locations = await locationsRes.json();

                const locSelect = document.getElementById('location');
                locations.forEach(loc => {
                    const opt = document.createElement('option');
                    opt.value = loc;
                    opt.textContent = loc;
                    locSelect.appendChild(opt);
                });

                // Add initial driver rows
                addDriverRow();
                addDriverRow();
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Failed to load data from API.');
            }
        }

        function addDriverRow() {
            const container = document.getElementById('drivers-container');
            const row = document.createElement('div');
            row.className = 'driver-row';
            
            row.innerHTML = `
                <div>
                    <label>Driver</label>
                    <select class="driver-select">
                        ${driversList.map(d => `<option value="${d}">${d}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label>Constructor</label>
                    <select class="constructor-select">
                        ${constructorsList.map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label>Grid Pos</label>
                    <input type="number" class="grid-input" min="1" max="20" value="1">
                </div>
                <button onclick="this.parentElement.remove()" style="background:#666; padding: 5px 10px;">X</button>
            `;
            container.appendChild(row);
        }

        async function predict() {
            const location = document.getElementById('location').value;
            const rows = document.querySelectorAll('.driver-row');
            const payload = [];

            rows.forEach(row => {
                payload.push({
                    driverId: row.querySelector('.driver-select').value,
                    constructorId: row.querySelector('.constructor-select').value,
                    grid: parseInt(row.querySelector('.grid-input').value),
                    Location: location
                });
            });

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const results = await response.json();
                displayResults(results);
            } catch (error) {
                console.error('Error predicting:', error);
                alert('Prediction failed.');
            }
        }

        function displayResults(results) {
            const container = document.getElementById('results-list');
            const resultsDiv = document.getElementById('results');
            container.innerHTML = '';
            resultsDiv.style.display = 'block';

            results.forEach((res, index) => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `
                    <span>${index + 1}. ${res.driverId}</span>
                    <span>${(res.win_probability * 100).toFixed(1)}%</span>
                `;
                container.appendChild(div);
            });
        }

        fetchData();
    </script>
</body>
</html>
